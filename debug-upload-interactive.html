<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Upload Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Teste Upload Supabase Debug</h1>
    
    <div class="test-section">
        <h2>üìã Configura√ß√£o Atual</h2>
        <div id="config" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üîó Teste de Conex√£o</h2>
        <button onclick="testConnection()">Testar Conex√£o</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üì§ Teste Upload de Imagem</h2>
        <input type="file" id="imageFile" accept="image/*">
        <br>
        <button onclick="testImageUpload()">Fazer Upload</button>
        <div id="upload-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Log Completo</h2>
        <div id="log" class="result"></div>
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiZW5zdGxieHhsbXF3aHB2b3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNjc4ODEsImV4cCI6MjA4Mjk0Mzg4MX0.CxgHp7f_LXjVm2hf7bG1kgs0WFrQmPKA3Te8ma1HD4w';
        const SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiZW5zdGxieHhsbXF3aHB2b3NlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NzM2Nzg4MSwiZXhwIjoyMDgyOTQzODgxfQ.YMMWKo6_E55LcRSRW4aQA3CiLxwoUPsqPBFSfuaRtU4';
        const URL = 'https://wbenstlbxxlmqwhpvose.supabase.co';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function showConfig() {
            const config = `
URL: ${URL}
Anon Key: ${API_KEY.substring(0, 20)}...
Service Key: ${SERVICE_KEY.substring(0, 20)}...
User Agent: ${navigator.userAgent}
Language: ${navigator.language}`;
            showResult('config', config);
        }

        async function testConnection() {
            log('Iniciando teste de conex√£o...');
            showResult('connection-result', 'Testando...', 'info');

            try {
                const response = await fetch(`${URL}/rest/v1/`, {
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                log(`Status: ${response.status}`);
                
                if (response.ok) {
                    const result = `‚úÖ Conex√£o OK
Status: ${response.status}
Headers: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}`;
                    showResult('connection-result', result, 'success');
                    log('Conex√£o bem-sucedida!', 'success');
                } else {
                    const error = await response.text();
                    const result = `‚ùå Erro na conex√£o
Status: ${response.status}
Error: ${error}`;
                    showResult('connection-result', result, 'error');
                    log(`Erro na conex√£o: ${error}`, 'error');
                }
            } catch (error) {
                const result = `‚ùå Erro geral
Error: ${error.message}`;
                showResult('connection-result', result, 'error');
                log(`Erro geral: ${error.message}`, 'error');
            }
        }

        async function testImageUpload() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (!file) {
                showResult('upload-result', 'Selecione uma imagem primeiro!', 'error');
                log('Nenhum arquivo selecionado', 'error');
                return;
            }

            log(`Iniciando upload: ${file.name} (${file.type}, ${file.size} bytes)`);
            showResult('upload-result', 'Fazendo upload...', 'info');

            try {
                // Valida√ß√µes
                const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
                const maxSize = 5 * 1024 * 1024;

                if (!allowedTypes.includes(file.type)) {
                    throw new Error(`Formato n√£o suportado: ${file.type}`);
                }

                if (file.size > maxSize) {
                    throw new Error(`Arquivo muito grande: ${file.size} bytes`);
                }

                // Upload
                const formData = new FormData();
                formData.append('file', file, `test-${Date.now()}.${file.type.split('/')[1]}`);

                const response = await fetch(`${URL}/storage/v1/object/renove-images/test-${Date.now()}.${file.type.split('/')[1]}`, {
                    method: 'POST',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: formData
                });

                log(`Upload status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    const success = `‚úÖ Upload sucesso!
Key: ${result.Key}
Id: ${result.Id}`;
                    showResult('upload-result', success, 'success');
                    log('Upload realizado com sucesso!', 'success');

                    // Limpar arquivo
                    await fetch(`${URL}/storage/v1/object/renove-images/${result.Key}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': API_KEY,
                            'Authorization': `Bearer ${API_KEY}`
                        }
                    });
                    log('Arquivo de teste removido', 'info');
                } else {
                    const error = await response.text();
                    const fail = `‚ùå Upload falhou
Status: ${response.status}
Error: ${error}`;
                    showResult('upload-result', fail, 'error');
                    log(`Upload falhou: ${error}`, 'error');
                }
            } catch (error) {
                const fail = `‚ùå Erro no upload
Error: ${error.message}`;
                showResult('upload-result', fail, 'error');
                log(`Erro no upload: ${error.message}`, 'error');
            }
        }

        // Inicializar
        showConfig();
        log('P√°gina de debug carregada');
    </script>
</body>
</html>
